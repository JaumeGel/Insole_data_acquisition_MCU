# Insole Data Acquisition MCU Firmware

STM32 firmware for the Insole data acquisition PCB.
This project runs on an STM32 (STM32U5 family) microcontroller, reads analog data from the ADC and a capacitive sensor over SPI, and forwards the acquired data wirelessly using an external BlueNRG‑M2 Bluetooth module connected over SPI.

This README describes the repository layout, how to build and flash the firmware, important configuration points (pins, sensors, sampling), and where to look to adapt behavior.

---

## Disclaimer

Most of the content in this README was generated by GitHub Copilot (an AI assistant). It was added to help document the project quickly. Please review and verify details (pin assignments, data formats, and build instructions) against the actual source files and hardware before relying on them for development or deployment.

---

## Features

- ADC 14-bit sampling (insole sensors)
- Capacitive sensor readout via SPI (PCAP04 driver located in repository)
- Wireless data transmission via an external BlueNRG‑M2 module over SPI (BlueNRG stack included)
- Project configured with STM32Cube (IOC + generated code)
- Linker scripts for STM32U575RGTX provided

---

## Repository layout (key files)

- [Core/Src/main.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Src/main.c) — application entry, scheduler and main data-acquisition loop (sampling, packaging, and transmit)
- [Core/Src/custom_bus.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Src/custom_bus.c) — low-level board-specific peripheral glue (SPI/ADC/CS handling)
- [Core/Inc/main.h](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Inc/main.h) — main definitions and prototypes
- [Core/Inc/custom_bus.h](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Inc/custom_bus.h) — public declarations for custom_bus
- [PCAP04/user_spi_interface.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/PCAP04/user_spi_interface.c) — SPI interface for the capacitive sensor
- [PCAP04/user_spi_interface.h](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/PCAP04/user_spi_interface.h) — header for the PCAP SPI interface
- [BlueNRG_2/](https://github.com/JaumeGel/Insole_data_acquisition_MCU/tree/master/BlueNRG_2) — BlueNRG stack and example/target folders (BLE service/app code lives here)
- [Insole_data_acquisition_MCU.ioc](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Insole_data_acquisition_MCU.ioc) — STM32CubeMX project configuration

---

## Supported hardware

- MCU: STM32U5 family (project prepared for STM32U575RGTX)
- Capacitive sensor: PCAP04 (SPI) — driver and user SPI interface present in `PCAP04/`
- Bluetooth module: ST BlueNRG‑M2 (external module, connected over SPI)
- Programmer: ST‑Link (or other SWD-compatible programmer)

---

## Build & Flash

Recommended: STM32CubeIDE (project files and .ioc are included)

1. Clone the repository:
   git clone https://github.com/JaumeGel/Insole_data_acquisition_MCU.git

2. Open the project in STM32CubeIDE:
   - Open the included Insole_data_acquisition_MCU.ioc file
   - Regenerate code if you change peripherals in CubeMX

3. Build the project:
   - Use the STM32CubeIDE build button (which invokes the arm-none-eabi toolchain)
   - Or build from command line with the same toolchain/Makefile if you extract one

4. Flash to the board:
   - Use the IDE's debugger (ST‑Link) or your preferred flasher to program the firmware
   - Ensure the correct target device (STM32U575RGTX) and the appropriate linker script are selected

---

## Configuration & Important Code Locations

- Pin and peripheral configuration are generated from `Insole_data_acquisition_MCU.ioc` and visible in `Core/Inc/stm32u5xx_hal_conf.h` and `Core/Src/stm32u5xx_hal_msp.c`.
- SPI/ADC glue: check `Core/Src/custom_bus.c` and `Core/Inc/custom_bus.h` for how SPI and ADC are initialized and how chip-select lines are handled.
- Capacitive sensor: `PCAP04/user_spi_interface.c` implements the platform-specific SPI transfers and timing for the PCAP04 device.
- BLE stack and application code: see the `BlueNRG_2/` folder for the stack and the custom application that advertises/services sensor data over BLE. The actual GATT definitions and data transfer logic live inside that folder.
- Sampling rate and buffering: configurable in `Core/Src/main.c` — adjust timers, DMA or ADC start triggers here if you need a different sampling frequency or sample aggregation.

---

## Data format & Bluetooth behavior

- Firmware collects ADC channels as 14-bit data and capacitive sensor readings as 32-bit data and forwards them to the BlueNRG module for wireless transfer.
- The repository includes the BlueNRG middleware and example application; the BLE data format (GATT characteristics and notification payload) is defined in the BlueNRG application files under `BlueNRG_2/Custom_App` and/or `BlueNRG_2/Target`. Inspect those files to understand the exact packet layout expected by the host app.
- If you are writing a PC / mobile client, look for a custom GATT service in the BlueNRG sources; the client subscribes to notifications to receive streaming sensor data.
- `BlueNRG_2/Custom_App/gatt_db.c` contains the UUID for the created service and added characteristics. Note that 2 characteristics for resistor sensors are created and 4 for capacitive ones in order to fit all the data in the available packet length.
- The peripheral passkey is 123456

---

## Tuning & Modifications

- To change ADC channels or sampling:
  - Update ADC configuration in the .ioc (or in HAL init code) and adapt the read logic in `main.c` / `custom_bus.c`.
- To modify capacitive sensor behavior:
  - Adjust SPI transfer timing and commands in `PCAP04/user_spi_interface.c`.
- To change BLE behavior (advertising, characteristics, security):
  - Modify the BlueNRG application under `BlueNRG_2/Custom_App` (or `BlueNRG_2/Target`) and rebuild the BlueNRG project if necessary.

---

## Notes about licensing and contribution

- No license file is included in this repository. If you plan to reuse or redistribute this code, ask the repository owner or add a license.
- Contributions, bug reports, and feature requests are welcome — open an issue or create a pull request in the repository.

---

## References & useful files

- Project IOC (CubeMX): [Insole_data_acquisition_MCU.ioc](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Insole_data_acquisition_MCU.ioc)
- Main application: [Core/Src/main.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Src/main.c)
- Board/peripheral glue: [Core/Src/custom_bus.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Src/custom_bus.c) and [Core/Inc/custom_bus.h](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/Core/Inc/custom_bus.h)
- Capacitive sensor SPI: [PCAP04/user_spi_interface.c](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/PCAP04/user_spi_interface.c)
- BlueNRG middleware and examples: [BlueNRG_2/](https://github.com/JaumeGel/Insole_data_acquisition_MCU/tree/master/BlueNRG_2)
- Linker scripts: [STM32U575RGTX_FLASH.ld](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/STM32U575RGTX_FLASH.ld), [STM32U575RGTX_RAM.ld](https://github.com/JaumeGel/Insole_data_acquisition_MCU/blob/master/STM32U575RGTX_RAM.ld)

---

## Contact

Author / Maintainer: JaumeGel  
Repository: https://github.com/JaumeGel/Insole_data_acquisition_MCU

If you need help adapting the code to other STM32 variants, to change the BLE packet format or to integrate with a PC/mobile client, please open an issue describing your target device and use-case.
